name: Flipper - CI/CD - Windows & Android & Google Play

on:
  # Enable manual run
  workflow_dispatch:
    inputs:
      lane:
        description: "Fastlane lane"
        required: true
        default: "internal"
        type: choice
        options:
          - beta
          - promote_to_production
          - production
  push:
    branches:
      - 'feature-*'
      - 'hotfix-*'
      - 'bugfix-*'
      - main
      - dev
      - end-user-facing
      - shifts
      - mislenous-post-mondy-merge
env:
  URL: ${{ secrets.DB_URL }}
  PASSWORD: ${{ secrets.DB_PASSWORD }}
  SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
  # SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }} # Securely store this
  IS_TEST_ENV: true

jobs:
  unit-testing:
    name: Unit Testing
    if: false
    runs-on: ubuntu-latest
    env:
      FLUTTER_TEST_CI: true
    # needs: [supabase-init] # Requires Supabase to be initialized
    steps:
      - uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
        with:
          submodules: recursive
          token: ${{ secrets.ACCESS_TOKEN }}
          persist-credentials: true

      - name: Force submodule update
        run: git submodule update --init --force --recursive

      - uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.8"
          channel: "stable"
      - run: |
          git submodule update --init
      - name: Load melos
        run: |
          dart pub global activate melos 7.3.0
          melos bootstrap
          melos run generate:icons

      - name: Configure Missing files
        shell: bash
        run: |
          echo "$INDEX" >> apps/flipper/web/index.html
          echo "$CONFIGDART" >> packages/flipper_login/lib/config.dart
          echo "$SECRETS" >> packages/flipper_models/lib/secrets.dart
          echo "$SECRETS" >> apps/flipper_web/lib/core/secrets.dart
          echo "$FIREBASEOPTIONS" >> apps/flipper/lib/firebase_options.dart
          echo "$FIREBASEOPTIONS" >> packages/flipper_models/lib/firebase_options.dart
          echo "$AMPLIFY_CONFIG" >> apps/flipper/lib/amplifyconfiguration.dart
          echo "$AMPLIFY_TEAM_PROVIDER" >> apps/flipper/amplify/team-provider-info.json
          git config --global core.autocrlf false
          echo "$AMPLIFY_TEAM_PROVIDER" >> apps/flipper/amplify/team-provider-info.json
        env:
          INDEX: ${{ secrets.INDEX }}
          CONFIGDART: ${{ secrets.CONFIGDART }}
          SECRETS: ${{ secrets.SECRETS }}
          FIREBASEOPTIONS: ${{ secrets.FIREBASEOPTIONS }}
          AMPLIFY_CONFIG: ${{ secrets.AMPLIFY_CONFIG }}
          AMPLIFY_TEAM_PROVIDER: ${{ secrets.AMPLIFY_TEAM_PROVIDER }}

      - name: Install LCOV
        run: sudo apt-get update && sudo apt-get install -y lcov

      - name: Run tests with coverage
        run: |
          cd packages/flipper_dashboard
          cd ../..
          melos run test:ci
#  # dart run realm install
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: packages/flipper_dashboard/coverage 
  build_web_deploy_firebase:
    runs-on: ubuntu-latest
    needs: [unit-testing]
    if: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.ACCESS_TOKEN }}
          persist-credentials: true

      - name: Force submodule update
        run: git submodule update --init --force --recursive
      
      # Setup Flutter (No changes needed here)
      - name: Clone Flutter repository with stable channel
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.8" # Consider using a more recent stable Flutter version if possible/needed
          channel: stable
      - run: flutter doctor -v

      # Git initialization and submodule handling (No changes needed here)
      - name: Initialize Git repository
        run: git init 
      - name: Submodule init and update
        run: git submodule update --init
        
      # Configure secrets (No changes needed here)
      - name: Configure Missing files
        shell: bash
        run: |
          echo "$CONFIGDART" >> packages/flipper_login/lib/config.dart
          echo "$SECRETS" >> packages/flipper_models/lib/secrets.dart
          echo "$SECRETS" >> apps/flipper_web/lib/core/secrets.dart
          echo "$FIREBASEOPTIONS" >> apps/flipper/lib/firebase_options.dart
          echo "$FIREBASEOPTIONS" >> packages/flipper_models/lib/firebase_options.dart
          echo "$AMPLIFY_CONFIG" >> apps/flipper/lib/amplifyconfiguration.dart
          echo "$AMPLIFY_TEAM_PROVIDER" >> apps/flipper/amplify/team-provider-info.json
        env:
          INDEX: ${{ secrets.INDEX }}
          CONFIGDART: ${{ secrets.CONFIGDART }}
          SECRETS: ${{ secrets.SECRETS }}
          FIREBASEOPTIONS: ${{ secrets.FIREBASEOPTIONS }}
          AMPLIFY_CONFIG: ${{ secrets.AMPLIFY_CONFIG }} 
          AMPLIFY_TEAM_PROVIDER: ${{ secrets.AMPLIFY_TEAM_PROVIDER }}
          
      - name: Set up Node.js for Firebase CLI
        uses: actions/setup-node@v4 
        with:
          node-version: '20' # Specify Node.js v20.x LTS

      - name: Bootstrap dependencies
        run: |
          dart pub global activate melos 7.3.0
          melos bootstrap

      - name: Build Flipper app
        run: |
          cd apps/flipper
          flutter build web --release # Added --release flag for production builds
          
      - name: Deploy Flipper app to Firebase Hosting
        id: deploy_flipper
        uses: FirebaseExtended/action-hosting-deploy@v0.9.0 # Consider using @v0 for latest fixes if needed
        with:
          entryPoint: apps/flipper # This should point to the directory containing firebase.json and the build output (usually build/web within the app)
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_YEGOBOX_2EE43 }}
          channelId: pr-${{ github.event.commits.id }}
          # channelId: live
          projectId: yegobox-2ee43
      - name: Echo Flipper URL
        run: echo "Flipper app deployed to ${{ steps.deploy_flipper.outputs.urls }}"

      - name: Build Flipper Web app
        run: |
          cd apps/flipper_web
          flutter build web  --release
          
      - name: Deploy Flipper Web app to Firebase Hosting
        id: deploy_flipper_web
        uses: FirebaseExtended/action-hosting-deploy@v0.9.0
        with:
          entryPoint: apps/flipper_web
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_YEGOBOX_2EE43 }}
          channelId: pr-${{ github.event.commits.id }}
          # channelId: live
          projectId: yegobox-2ee43
      - name: Echo Flipper Web URL
        run: echo "Flipper Web app deployed to ${{ steps.deploy_flipper_web.outputs.urls }}"
  integration-testing-windows:
    name: "Integration Testing Windows"
    runs-on: windows-2022
    # if: false  # skip for now as it is flaky
    needs: [build_web_deploy_firebase] # Requires Supabase to be initialized
    steps:
      - name: Export pub environment variable on Windows
        run: |
          if [ "$RUNNER_OS" == "Windows" ]; then
            echo "PUB_CACHE=$LOCALAPPDATA\\Pub\\Cache" >> $GITHUB_ENV
          fi
        shell: bash
      - run: git config --global core.autocrlf false
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.ACCESS_TOKEN }}
          persist-credentials: true

      - name: Force submodule update
        run: git submodule update --init --force --recursive
      - name: Clone Flutter repository with stable channel
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.8"
          channel: stable
      - run: flutter doctor -v

      - uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: submodule init
        run: |
          git submodule update --init
          dart pub global activate melos 7.3.0
          melos bootstrap
      - name: Configure Missing files
        shell: bash
        run: |
          echo "$INDEX" >> apps/flipper/web/index.html
          echo "$CONFIGDART" >> packages/flipper_login/lib/config.dart
          echo "$SECRETS" >> packages/flipper_models/lib/secrets.dart
          echo "$SECRETS" >> apps/flipper_web/lib/core/secrets.dart
          echo "$FIREBASEOPTIONS" >> apps/flipper/lib/firebase_options.dart
          echo "$FIREBASEOPTIONS" >> packages/flipper_models/lib/firebase_options.dart
          echo "$AMPLIFY_CONFIG" >> apps/flipper/lib/amplifyconfiguration.dart
          echo "$AMPLIFY_TEAM_PROVIDER" >> apps/flipper/amplify/team-provider-info.json
        env:
          INDEX: ${{ secrets.INDEX }}
          CONFIGDART: ${{ secrets.CONFIGDART }}
          SECRETS: ${{ secrets.SECRETS }}
          FIREBASEOPTIONS: ${{ secrets.FIREBASEOPTIONS }}
          AMPLIFY_CONFIG: ${{ secrets.AMPLIFY_CONFIG }}
          AMPLIFY_TEAM_PROVIDER: ${{ secrets.AMPLIFY_TEAM_PROVIDER }}
      - run: |
          cd apps/flipper
          flutter test --dart-define=FLUTTER_TEST_ENV=true -d windows integration_test/smoke_windows_test.dart
  
  build-and-release-windows-debug:
    name: "Build windows app-debug"
    # if: false  # skip for now as it is flaky
    runs-on: windows-latest
    # needs: [unit-testing,build_web_deploy_firebase] # Requires Supabase to be initialized
    # 
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.ACCESS_TOKEN }} # Use a token with repo scope for releases
          persist-credentials: true

      - name: Force submodule update
        run: git submodule update --init --force --recursive

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.8"
          channel: stable
          cache: true

      - name: Setup melos
        run: |
          dart pub global activate melos 7.3.0
          melos bootstrap

      - name: Configure Missing files
        shell: bash
        run: |
          echo "$INDEX" >> apps/flipper/web/index.html
          echo "$CONFIGDART" >> packages/flipper_login/lib/config.dart
          echo "$SECRETS" >> packages/flipper_models/lib/secrets.dart
          echo "$SECRETS" >> apps/flipper_web/lib/core/secrets.dart
          echo "$FIREBASEOPTIONS" >> apps/flipper/lib/firebase_options.dart
          echo "$FIREBASEOPTIONS" >> packages/flipper_models/lib/firebase_options.dart
          echo "$AMPLIFY_CONFIG" >> apps/flipper/lib/amplifyconfiguration.dart
          echo "$AMPLIFY_TEAM_PROVIDER" >> apps/flipper/amplify/team-provider-info.json
        env:
          INDEX: ${{ secrets.INDEX }}
          CONFIGDART: ${{ secrets.CONFIGDART }}
          SECRETS: ${{ secrets.SECRETS }}
          FIREBASEOPTIONS: ${{ secrets.FIREBASEOPTIONS }}
          AMPLIFY_CONFIG: ${{ secrets.AMPLIFY_CONFIG }}
          AMPLIFY_TEAM_PROVIDER: ${{ secrets.AMPLIFY_TEAM_PROVIDER }}

      - name: Build and Package
        run: |
          cd apps/flipper
          flutter clean
          dart run msix:create -v --install-certificate false --signtool-options "/td SHA256"

      - name: Extract msix_version
        id: get_version
        shell: powershell
        run: |
          $MSIX_VERSION = (Get-Content -Path "apps/flipper/pubspec.yaml" -Raw) -match 'msix_config:\s*([\s\S]*?)\bmsix_version:\s*(\d+\.\d+\.\d+\.\d+)\b' | ForEach-Object { if ($matches.Count -ge 2) { $matches[2] } else { Write-Output "No msix_version found"; exit 1 } }; echo "version=$MSIX_VERSION" >> $env:GITHUB_OUTPUT

      - name: Create Debug Release
        uses: softprops/action-gh-release@v2
        with:
          files: apps/flipper/build/windows/x64/runner/Release/flipper_rw.msix
          tag_name: v${{ steps.get_version.outputs.version }}_windows_debug
          name: Windows Debug Release ${{ steps.get_version.outputs.version }}
          draft: false
          body: |
            Debug Release for QA
        env:
          GITHUB_TOKEN: ${{ github.token }} 

  build-and-release-windows-prod:
    name: "Build windows app-store"
    if: github.ref == 'refs/heads/main'
    runs-on: windows-latest
    # integration-testing-windows,build_web_deploy_firebase
    # For now intrested in unit testing as web deployment is broken we will re-add need to depend on integration-testing-windows,build_web_deploy_firebase later
    # needs: [unit-testing] # Requires Supabase to be initialized
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.ACCESS_TOKEN }}  # Use a PAT
          persist-credentials: true  # Keep this for checkout

      - name: Force submodule update
        run: git submodule update --init --force --recursive

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.8"
          channel: stable
          cache: true

      - name: Initialize submodules
        run: git submodule update --init

      - name: Setup melos
        run: |
          dart pub global activate melos 7.3.0
          melos bootstrap

      - name: Configure Missing files 
        shell: bash
        run: |
          echo "$INDEX" >> apps/flipper/web/index.html
          echo "$CONFIGDART" >> packages/flipper_login/lib/config.dart
          echo "$SECRETS" >> packages/flipper_models/lib/secrets.dart
          echo "$SECRETS" >> apps/flipper_web/lib/core/secrets.dart
          echo "$FIREBASEOPTIONS" >> apps/flipper/lib/firebase_options.dart
          echo "$FIREBASEOPTIONS" >> packages/flipper_models/lib/firebase_options.dart
          echo "$AMPLIFY_CONFIG" >> apps/flipper/lib/amplifyconfiguration.dart
          echo "$AMPLIFY_TEAM_PROVIDER" >> apps/flipper/amplify/team-provider-info.json
        env:
          INDEX: ${{ secrets.INDEX }}
          CONFIGDART: ${{ secrets.CONFIGDART }}
          SECRETS: ${{ secrets.SECRETS }}
          FIREBASEOPTIONS: ${{ secrets.FIREBASEOPTIONS }}
          AMPLIFY_CONFIG: ${{ secrets.AMPLIFY_CONFIG }}
          AMPLIFY_TEAM_PROVIDER: ${{ secrets.AMPLIFY_TEAM_PROVIDER }}

      - name: Build and Package
        run: |
          cd apps/flipper
          flutter clean
          dart run msix:create --store

      - name: Extract msix_version
        id: get_version
        shell: powershell
        run: |
          $MSIX_VERSION = (Get-Content -Path "apps/flipper/pubspec.yaml" -Raw) -match 'msix_config:\s*([\s\S]*?)\bmsix_version:\s*(\d+\.\d+\.\d+\.\d+)\b' | ForEach-Object { if ($matches.Count -ge 2) { $matches[2] } else { Write-Output "No msix_version found"; exit 1 } }; echo "version=$MSIX_VERSION" >> $env:GITHUB_OUTPUT

      - name: Create Production Release
        uses: softprops/action-gh-release@v2
        with:
          files: apps/flipper/build/windows/x64/runner/Release/flipper_rw.msix
          tag_name: v${{ steps.get_version.outputs.version }}_windows_prod
          name: Windows Production Release ${{ steps.get_version.outputs.version }}
          draft: false
          body: |
            Production Release for Windows App Store
        env:
          GITHUB_TOKEN: ${{ github.token }}  # Use the default GITHUB_TOKEN
  
  fastlane-deploy:
    name: "Google Deploy ${{ matrix.app }}"
    if: github.ref != 'refs/heads/main' # Skip this job on main branch
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      FLUTTER_TEST_CI: true

    strategy:
      fail-fast: false
      matrix:
        app: [flipper, flipper_auth]
    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          android: false
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      - run: git config --global core.autocrlf false
      # Set up Flutter.
      - name: Clone Flutter repository with stable channel
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.8" #firebase_auth_desktop is broken with  3.10.6
          channel: stable
      - run: flutter doctor -v

      # Checkout flipper code
      - name: Checkout flipper code
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9
        with:
          submodules: recursive
          token: ${{ secrets.ACCESS_TOKEN }}
          persist-credentials: true

      - name: Force submodule update
        run: git submodule update --init --force --recursive
      - uses: actions/setup-java@v4 #plugin for setting up the java
        with:
          distribution: "zulu"
          java-version: "17" #defines the java version
      
      - name: Accept Android licenses
        run: |
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "ndk;28.0.12674087"
      - name: Configure Git with PAT
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          git config --global user.email "info@yegobox.com"
          git config --global user.name "YEGOBOX"
          git config --global credential.helper store
          echo "https://github.com:${PAT_TOKEN}@github.com" > ~/.git-credentials
      - name: Initialize submodules
        run: git submodule update --init
      - name: Setup melos
        run: |
          dart pub global activate melos 7.3.0
          melos bootstrap
      - name: Configure Missing files
        run: |
          echo "$INDEX" >> apps/flipper/web/index.html
          echo "$CONFIGDART" >> packages/flipper_login/lib/config.dart
          echo "$SECRETS" >> packages/flipper_models/lib/secrets.dart
          echo "$SECRETS" >> apps/flipper_web/lib/core/secrets.dart
          if [ "${{ matrix.app }}" = "flipper_auth" ]; then
            echo "$SECRETS" >> apps/flipper_auth/lib/core/secrets.dart
          fi
          echo "$FIREBASEOPTIONS" >> apps/flipper/lib/firebase_options.dart
          echo "$FIREBASEOPTIONS" >> packages/flipper_models/lib/firebase_options.dart
          git config --global core.autocrlf false
          echo "$AMPLIFY_CONFIG" >> apps/flipper/lib/amplifyconfiguration.dart
          echo "$AMPLIFY_TEAM_PROVIDER" >> apps/flipper/amplify/team-provider-info.json

        env:
          INDEX: ${{ secrets.INDEX }}
          CONFIGDART: ${{ secrets.CONFIGDART }}
          SECRETS: ${{ secrets.SECRETS }}
          FIREBASEOPTIONS: ${{ secrets.FIREBASEOPTIONS }}
          AMPLIFY_CONFIG: ${{ secrets.AMPLIFY_CONFIG }}
          AMPLIFY_TEAM_PROVIDER: ${{ secrets.AMPLIFY_TEAM_PROVIDER }}
      - name: Verify app exists
        run: |
          echo "Checking if apps/${{ matrix.app }} exists..."
          ls -la apps/
          ls -la apps/${{ matrix.app }}/
          ls -la apps/${{ matrix.app }}/android/
      - run: |
          dart pub global activate melos 7.3.0
          melos bootstrap
      
      # Get version from pubspec.yaml
      - name: Get version from pubspec.yaml
        id: get_version
        run: |
          VERSION=$(grep '^version:' apps/${{ matrix.app }}/pubspec.yaml | cut -d ' ' -f 2 | tr -d '\r')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
        
      # Setup Ruby, Bundler, and Gemfile dependencies
      - name: Setup Fastlane
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.0"
          bundler-cache: true
          # cache-version: 1
          working-directory: apps/${{ matrix.app }}/android
      - name: Write Posthog API Key to local.properties
        run: |
          echo "POSTHOG_API_KEY=${{ secrets.POSTHOG_API_KEY }}" > android/app/local.properties
        working-directory: apps/${{ matrix.app }}
      
      # ===== 16 KB PAGE SIZE COMPLIANCE CHECKS - START =====
      - name: Verify Android Gradle Plugin Version
        run: |
          echo "=========================================="
          echo "16 KB PAGE SIZE COMPLIANCE CHECK - AGP"
          echo "=========================================="
          
          # Check AGP version in build.gradle.kts files
          echo "Checking Android Gradle Plugin version..."
          
          # Check project-level build.gradle.kts
          if [ -f "build.gradle.kts" ]; then
            AGP_VERSION=$(grep 'com.android.application\|com.android.library' build.gradle.kts | grep -oP '\d+\.\d+\.\d+' | head -1)
            echo "Found AGP version: $AGP_VERSION"
            
            # Extract major and minor version (e.g., 8.5 from 8.5.1)
            MAJOR=$(echo $AGP_VERSION | cut -d. -f1)
            MINOR=$(echo $AGP_VERSION | cut -d. -f2)
            
            # Check if AGP is 8.5.1 or higher
            if [ "$MAJOR" -gt 8 ] || { [ "$MAJOR" -eq 8 ] && [ "$MINOR" -ge 5 ]; }; then
              echo "✅ AGP version $AGP_VERSION supports 16 KB page size alignment"
            else
              echo "⚠️  WARNING: AGP version $AGP_VERSION may not support 16 KB page size"
              echo "⚠️  Recommended: AGP 8.5.1 or higher"
              echo "⚠️  Please update your build.gradle.kts"
            fi
          else
            echo "⚠️  Could not find build.gradle.kts to verify AGP version"
          fi
          
          # Also check settings.gradle.kts
          if [ -f "settings.gradle.kts" ]; then
            echo "Checking settings.gradle.kts..."
            grep -i "android" settings.gradle.kts || true
          fi
          
          echo "=========================================="
        working-directory: apps/${{ matrix.app }}/android

      - name: Verify NDK Configuration
        run: |
          echo "=========================================="
          echo "16 KB PAGE SIZE COMPLIANCE CHECK - NDK"
          echo "=========================================="
          
          # Verify NDK version
          NDK_VERSION="28.0.12674087"
          if [ -d "$ANDROID_HOME/ndk/$NDK_VERSION" ]; then
            echo "✅ NDK $NDK_VERSION is installed (supports 16 KB alignment by default)"
            
            # Check NDK version details
            if [ -f "$ANDROID_HOME/ndk/$NDK_VERSION/source.properties" ]; then
              echo "NDK Details:"
              cat "$ANDROID_HOME/ndk/$NDK_VERSION/source.properties"
            fi
          else
            echo "⚠️  WARNING: NDK $NDK_VERSION not found"
            echo "Available NDK versions:"
            ls -la $ANDROID_HOME/ndk/ || echo "No NDK directory found"
          fi
          
          # Check if app uses native code
          if [ -d "app/src/main/jniLibs" ] || [ -d "app/src/main/cpp" ]; then
            echo "Native code detected - 16 KB alignment is CRITICAL"
          else
            echo "No native code detected in app/src/main/"
          fi
          
          echo "=========================================="
        working-directory: apps/${{ matrix.app }}/android

      - name: Check Build Configuration for 16 KB Support
        run: |
          echo "=========================================="
          echo "16 KB PAGE SIZE COMPLIANCE CHECK - BUILD CONFIG"
          echo "=========================================="
          
          # Check gradle.properties for 16 KB related settings
          if [ -f "gradle.properties" ]; then
            echo "Checking gradle.properties..."
            cat gradle.properties | grep -i "android" || true
          fi
          
          # Check app-level build.gradle.kts
          if [ -f "app/build.gradle.kts" ]; then
            echo "Checking app/build.gradle.kts for relevant configurations..."
            
            # Check targetSdk
            TARGET_SDK=$(grep 'targetSdk' app/build.gradle.kts | grep -oP '\d+' | head -1)
            echo "Target SDK: $TARGET_SDK"
            
            if [ "$TARGET_SDK" -ge 35 ]; then
              echo "✅ Target SDK $TARGET_SDK - 16 KB page size support REQUIRED"
            elif [ "$TARGET_SDK" -ge 34 ]; then
              echo "⚠️  Target SDK $TARGET_SDK - 16 KB support recommended"
            fi
            
            # Check for ndk configurations
            echo "Checking NDK configuration..."
            grep -A 5 "ndk {" app/build.gradle.kts || echo "No explicit NDK configuration found"
            
            # Check for packaging options
            echo "Checking packaging options..."
            grep -A 10 "packagingOptions\|packaging {" app/build.gradle.kts || echo "No explicit packaging options found"
          fi
          
          echo "=========================================="
        working-directory: apps/${{ matrix.app }}/android

      - name: Check Flutter 16 KB Compatibility
        run: |
          echo "=========================================="
          echo "16 KB PAGE SIZE COMPLIANCE CHECK - FLUTTER"
          echo "=========================================="
          
          FLUTTER_VERSION=$(flutter --version | head -1)
          echo "Flutter version: $FLUTTER_VERSION"
          
          # Check if pubspec.yaml has any native plugins
          echo "Checking for Flutter plugins that may use native code..."
          cd apps/${{ matrix.app }}
          
          if [ -f "pubspec.yaml" ]; then
            echo "Dependencies in pubspec.yaml:"
            grep -A 100 "^dependencies:" pubspec.yaml | grep "  [a-z]" | head -20
          fi
          
          # Check flutter build configuration
          if [ -f "android/app/build.gradle.kts" ]; then
            echo "Checking Flutter Android configuration..."
            grep -i "flutter" android/app/build.gradle.kts || true
          fi
          
          echo "=========================================="
        working-directory: ${{ github.workspace }}
      # ===== 16 KB PAGE SIZE COMPLIANCE CHECKS - END =====
      
      - name: Set environment variables
        run: |
          if [ "${{ matrix.app }}" = "flipper_auth" ]; then
            cat << 'ENV_EOF' >> "$GITHUB_ENV"
          PLAY_STORE_UPLOAD_KEY<<EOF
          ${{ secrets.PLAY_STORE_UPLOAD_KEY }}
          EOF
          KEYSTORE_KEY_ALIAS=${{ secrets.KEYSTORE_KEY_ALIAS }}
          KEYSTORE_KEY_PASSWORD=${{ secrets.KEYSTORE_KEY_PASSWORD }}
          KEYSTORE_STORE_PASSWORD=${{ secrets.KEYSTORE_STORE_PASSWORD }}
          GOOGLE_SERVICE_JSON<<EOF
          ${{ secrets.FLIPPER_AUTH_GOOGLE_SERVICE_JSON }}
          EOF
          ENV_EOF
          else
            cat << 'ENV_EOF' >> "$GITHUB_ENV"
          PLAY_STORE_UPLOAD_KEY<<EOF
          ${{ secrets.PLAY_STORE_UPLOAD_KEY }}
          EOF
          KEYSTORE_KEY_ALIAS=${{ secrets.KEYSTORE_KEY_ALIAS }}
          KEYSTORE_KEY_PASSWORD=${{ secrets.KEYSTORE_KEY_PASSWORD }}
          KEYSTORE_STORE_PASSWORD=${{ secrets.KEYSTORE_STORE_PASSWORD }}
          GOOGLE_SERVICE_JSON<<EOF
          ${{ secrets.GOOGLE_SERVICE_JSON }}
          EOF
          ENV_EOF
          fi
      - name: Configure Keystore
        run: |
          echo "$GOOGLE_SERVICE_JSON" > app/google-services.json
          echo "$PLAY_STORE_UPLOAD_KEY" | base64 --decode > app/key.jks
          echo "storeFile=key.jks" >> key.properties
          echo "keyAlias=$KEYSTORE_KEY_ALIAS" >> key.properties
          echo "storePassword=$KEYSTORE_STORE_PASSWORD" >> key.properties
          echo "keyPassword=$KEYSTORE_KEY_PASSWORD" >> key.properties
        working-directory: apps/${{ matrix.app }}/android
      - name: Verify package name before upload
        run: |
          echo "Verifying package name for ${{ matrix.app }}..."
          if [ "${{ matrix.app }}" = "flipper_auth" ]; then
            expected_package="rw.flipper.auth"
          else
            expected_package="rw.flipper"
          fi
          
          # Extract package name from build.gradle.kts
          actual_package=$(grep 'applicationId = ' app/build.gradle.kts | sed 's/.*applicationId = "\(.*\)".*/\1/')
          echo "Expected package: $expected_package"
          echo "Actual package: $actual_package"
          
          if [ "$actual_package" != "$expected_package" ]; then
            echo "ERROR: Package name mismatch!"
            exit 1
          fi
        working-directory: apps/${{ matrix.app }}/android
      - run: |
          bundle exec fastlane ${{ github.event.inputs.lane || 'internal' }}
        env:
          PLAY_STORE_CONFIG_JSON: ${{ matrix.app == 'flipper_auth' && secrets.FLIPPER_AUTH_PLAYSTORE_ACCOUNT_KEY || secrets.PLAYSTORE_ACCOUNT_KEY }}
          DB_URL: ${{ secrets.DB_URL }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        working-directory: apps/${{ matrix.app }}/android
      
      # ===== POST-BUILD 16 KB VERIFICATION - START =====
      - name: Verify AAB/APK 16 KB Compliance
        if: always()
        run: |
          SCRIPT_PATH="${{ github.workspace }}/apps/flipper/en_check_elf_alignment.sh"
          echo "=== Debug: Checking for script ===" 
          echo "Looking for script at: $SCRIPT_PATH"
          echo "Workspace directory:"
          ls -la "${{ github.workspace }}/apps/flipper/" 2>/dev/null || echo "apps/flipper directory not found"
          echo "=== End Debug ==="
          
          if [ ! -f "$SCRIPT_PATH" ]; then
            echo "::error::Verification script not found at $SCRIPT_PATH"
            exit 1
          fi
          chmod +x "$SCRIPT_PATH"

          SEARCH_DIR="apps/${{ matrix.app }}"
          echo "Searching for build artifact in $SEARCH_DIR..."
          
          # Debug: List directory structure
          echo "=== Debug: Listing build directories ==="
          ls -la "$SEARCH_DIR/" 2>/dev/null || echo "Directory $SEARCH_DIR not found"
          ls -la "$SEARCH_DIR/build/" 2>/dev/null || echo "Directory $SEARCH_DIR/build not found"
          ls -la "build/" 2>/dev/null || echo "Directory build/ not found"
          find "build/" -name "*.aab" -o -name "*.apk" 2>/dev/null || echo "No artifacts in build/"
          echo "=== End Debug ==="
          
          # Prioritize standard output directories
          ARTIFACT_PATH=$(find "$SEARCH_DIR/build/app/outputs/bundle" -name "*.aab" 2>/dev/null | head -n 1)
          if [ -z "$ARTIFACT_PATH" ]; then
            ARTIFACT_PATH=$(find "$SEARCH_DIR/build/app/outputs/apk" -name "*.apk" 2>/dev/null | head -n 1)
          fi

          # Check custom build directory (build.gradle.kts redirects to workspace root)
          if [ -z "$ARTIFACT_PATH" ]; then
            echo "Checking custom build directory at workspace root..."
            ARTIFACT_PATH=$(find "build/app/outputs/bundle" -name "*.aab" 2>/dev/null | head -n 1)
            if [ -z "$ARTIFACT_PATH" ]; then
              ARTIFACT_PATH=$(find "build/app/outputs/apk" -name "*.apk" 2>/dev/null | head -n 1)
            fi
          fi

          # Fallback to searching the whole directory
          if [ -z "$ARTIFACT_PATH" ]; then
            echo "::warning::Build artifact not found in standard output paths, searching entire $SEARCH_DIR..."
            ARTIFACT_PATH=$(find "$SEARCH_DIR" -name "*.aab" -o -name "*.apk" | head -n 1)
          fi

          if [ -z "$ARTIFACT_PATH" ]; then
            echo "::error::Build artifact (.aab or .apk) not found in $SEARCH_DIR!"
            exit 1
          fi

          echo "Found artifact: $ARTIFACT_PATH"
          "$SCRIPT_PATH" "$ARTIFACT_PATH"
      # ===== POST-BUILD 16 KB VERIFICATION - END =====
      
      - name: Upload Android AAB
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ matrix.app }} Android AAB Release - ${{ github.ref_name }}
          tag_name: v${{ steps.get_version.outputs.version }}_${{ matrix.app }}
          draft: false
          body: |
            Debug Release for QA
            
            16 KB Page Size Compliance: Pre-deployment checks completed
            - AGP version verified
            - NDK 28.0.12674087 (16 KB alignment supported)
            - Build configuration checked
            - Post-build artifact verification completed
            
            ⚠️ Additional testing recommended on 16 KB page size devices
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  slackNotification:
    name: Slack Notification
    needs: [build-and-release-windows-debug, build-and-release-windows-prod,build_web_deploy_firebase]
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3.5.3
        with:
          submodules: recursive
          token: ${{ secrets.ACCESS_TOKEN }}
          persist-credentials: true

      - name: Force submodule update
        run: git submodule update --init --force --recursive
      - name: Slack Notification
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}